<!doctype html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <title>FI.js Form - Loan Pricing</title>
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">

        <style>
            body {
                -webkit-user-select: none; /* Disable text selection */
                -webkit-touch-callout: none; /* Disable callout, copy */
            }
            
            .dashboard-item {
                text-align: center;
                padding: 15px;
                background-color: var(--bs-light); /* Light background color from Bootstrap */
                color: var(--bs-dark); /* Text color for light mode */
                border-radius: 8px;
            }
            
            .dashboard-item-number i {
                font-size: 24px; /* Adjust the icon size */
                color: var(--bs-success); /* Use a Bootstrap variable for the icon color */
            }
            
            @media (prefers-color-scheme: dark) {
                .dashboard-item {
                    background-color: var(--bs-dark); /* Dark background color from Bootstrap */
                    color: var(--bs-light); /* Text color for dark mode */
                }
            }
            
            @keyframes pulse {
                0% { box-shadow: 0 0 0 0 rgba(57, 255, 20, 0.7); } /* Start from no shadow */
                70% { box-shadow: 0 0 10px 10px rgba(57, 255, 20, 0); } /* Expand shadow with fade-out */
                100% { box-shadow: 0 0 0 0 rgba(57, 255, 20, 0); } /* End with no shadow */
            }
            
            .progress-marker {
                position: absolute;
                top: 0;
                height: 100%;
                border-left: 4px solid #fff;
                z-index: 2;
                animation: pulse 2s infinite;
            }
            
            #spreadsheet input {
                border: none;
                background-color: transparent;
                width: 100%;
            }
        </style>
    </head>
    <body>
        <div class="container" style="margin-top: 5rem">
            <!-- Dashboard Section -->
            <div class="dashboard mb-4 p-3 border rounded">
                <h4 class="mb-3">Dashboard</h4>
                <div class="row">
                    <div class="col-md-4">
                        <div class="dashboard-item">
                            <h5>Annual Profit</h5>
                            <p id="dashLeft" class="dashboard-item-number">
                                <i class="hourglass-icon" aria-hidden="true">&#x1F552;</i>
                            </p>
                        </div> 
                    </div>
                    <div class="col-md-4">
                        <div class="dashboard-item">
                            <h5>Performance Grade</h5>
                            <p id="dashMid" class="dashboard-item-number">
                                <i class="hourglass-icon" aria-hidden="true">&#x1F552;</i>
                            </p>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="dashboard-item">
                            <h5>ROE</h5>
                            <p id="dashRight" class="dashboard-item-number">
                                <i class="hourglass-icon" aria-hidden="true">&#x1F552;</i>
                            </p>
                        </div>
                    </div>
                </div>
                <div class="row">
                    <div class="container my-4">
                        <div class="progress" style="position: relative; height: 30px;">
                            <div class="progress-bar bg-danger" role="progressbar" style="width: 25%" aria-valuenow="25" aria-valuemin="0" aria-valuemax="100">Weak</div>
                            <div class="progress-bar bg-warning" role="progressbar" style="width: 25%" aria-valuenow="25" aria-valuemin="0" aria-valuemax="100">Under</div>
                            <div class="progress-bar bg-success" role="progressbar" style="width: 25%" aria-valuenow="25" aria-valuemin="0" aria-valuemax="100">Best</div>
                            <div class="progress-bar bg-warning" role="progressbar" style="width: 25%" aria-valuenow="25" aria-valuemin="0" aria-valuemax="100">Over</div>
                            <!-- Marker Element -->
                            <div class="progress-marker"></div>
                        </div>
                    </div>
                </div>
            </div>
            <!-- Tab Navs -->
            <ul class="nav nav-tabs" id="formsTabs" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="personal-tab" data-bs-toggle="tab" data-bs-target="#personal" type="button" role="tab" aria-controls="personal" aria-selected="true">Loan Terms</button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="credit-tab" data-bs-toggle="tab" data-bs-target="#credit" type="button" role="tab" aria-controls="credit" aria-selected="false">Options & Submit</button>
                </li>
            </ul>
            <!-- Tab Content -->
            <div class="tab-content" id="formContent">
                <!-- Personal Information Tab -->
                <div class="tab-pane fade show active" id="personal" role="tabpanel" aria-labelledby="personal-tab">
                    <form class="p-3">
                        <div class="mb-3">
                            <select class="form-select" name="Type_select" id="Type_select" aria-label="Default select">
                                <option value="" selected>Choose loan type...</option>
                                <option value="Commercial">Commercial</option>
                                <option value="Commercial Real Estate">Commercial Real Estate</option>
                                <option value="Residential Real Estate">Residential Real Estate</option>
                                <option value="Consumer">Consumer</option>
                                <option value="Equipment">Equipment</option>
                                <option value="Home Equity">Home Equity</option>
                                <option value="Letter of Credit">Letter of Credit</option>
                            </select>
                        </div>
                        <input type="hidden" name="Type" id="Type" value="" />
                        <div class="mb-3">
                            <label for="Principal" class="form-label">Principal</label>
                            <input type="number" class="form-control" name="Principal" required>
                        </div>
                        <div class="mb-3">
                            <label for="Term" class="form-label">Contractual Term</label>
                            <input type="number" class="form-control" name="Term" required>
                        </div>
                        <div class="mb-3">
                            <label for="Amortization" class="form-label">Amortization</label>
                            <input type="number" class="form-control" name="Amortization">
                        </div>
                        <div class="mb-3">
                            <label for="InterestRate" class="form-label">Interest Rate (%)</label>
                            <input type="number" class="form-control percent-input" name="InterestRate" required>
                        </div>
                    </form>
                    <button type="button" class="btn btn-success next-tab">Next</button>
                </div>
                <!-- Credit Details Tab -->
                <div class="tab-pane fade" id="credit" role="tabpanel" aria-labelledby="credit-tab">
                    <form class="p-3">
                        <div class="mb-3">
                            <label for="Fees" class="form-label">Collected Fees</label>
                            <input type="number" class="form-control" name="Fees" value="0">
                        </div>
                        <div class="mb-3">
                            <label for="Reprice" class="form-label">Variable rate - months to reprice</label>
                            <input type="number" class="form-control" name="Reprice">
                        </div>
                        <div class="mb-3">
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="guarantee" id="noGuarantee" value="0" checked>
                                <label class="form-check-label" for="noGuarantee">
                                    No Guarantee
                                </label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="guarantee" id="personalGuarantee" value="1">
                                <label class="form-check-label" for="personalGuarantee">
                                    Personal Guarantee
                                </label>
                            </div>
                        </div>
                        <select class="form-select" name="LTV" size="3" aria-label="Size 3 select" required>
                            <option value="0.60">greater than-equal to 60% Loan-to-Value</option>
                            <option value="0.70">greater than-equal to 70% Loan-to-Value</option>
                            <option selected value="0.80">80% Loan-to-Value</option>
                            <option value="0.90">less than-equal to 90% Loan-to-Value</option>
                            <option value="1">less than-equal to 100% Loan-to-Value</option>
                            <option value="1.1">greater than 100% Loan-to-Value</option>
                            <option value="0">unsecured</option>
                        </select>
                    </form>
                    <button type="button" class="btn btn-secondary prev-tab">Back</button>
                    <button id="submitAll" type="button" class="btn btn-success">Submit</button>
                </div>
                <!-- Review & Submit Tab -->
                <div class="tab-pane fade" id="review" role="tabpanel" aria-labelledby="review-tab">
                    <form class="p-3">
                        <p>Review your information...</p>
                        
                    </form>
                    <button type="button" class="btn btn-secondary prev-tab">Back</button>
        
                <!-- Presenter Tab -->
                <div class="tab-pane fade" id="presenter_form" role="tabpanel" aria-labelledby="presenter-tab">
                    <form class="p-3">
                        <div id="presenter_div"></div>
                    </form>
                </div>
            </div>
        </div>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const nextButtons = document.querySelectorAll('.next-tab');
            const prevButtons = document.querySelectorAll('.prev-tab');
        
            // Handle "Next" button clicks
            nextButtons.forEach(button => {
                button.addEventListener('click', function () {
                    const activeTab = document.querySelector('.nav-tabs .nav-link.active');
                    const nextTab = activeTab.parentNode.nextElementSibling.querySelector('.nav-link');
                    if (nextTab) {
                        new bootstrap.Tab(nextTab).show();
                    }
                });
            });
        
            // Handle "Back" button clicks
            prevButtons.forEach(button => {
                button.addEventListener('click', function () {
                    const activeTab = document.querySelector('.nav-tabs .nav-link.active');
                    const prevTab = activeTab.parentNode.previousElementSibling.querySelector('.nav-link');
                    if (prevTab) {
                        new bootstrap.Tab(prevTab).show();
                    }
                });
            });
            // If you want to target the entire body for swipe gestures
            const swipeTarget = document.body;
            
            // Alternatively, if you have a specific content wrapper, you could use:
            // const swipeTarget = document.getElementById('contentWrapper');
            
            let startX;
        
            function onSwipeLeft() {
                const activeTab = document.querySelector('.nav-tabs .nav-link.active');
                const nextTab = activeTab.parentNode.nextElementSibling?.querySelector('.nav-link');
                if (nextTab) {
                    new bootstrap.Tab(nextTab).show();
                }
            }
        
            function onSwipeRight() {
                const activeTab = document.querySelector('.nav-tabs .nav-link.active');
                const prevTab = activeTab.parentNode.previousElementSibling?.querySelector('.nav-link');
                if (prevTab) {
                    new bootstrap.Tab(prevTab).show();
                }
            }
        
            swipeTarget.addEventListener('touchstart', function(e) {
                startX = e.touches[0].clientX;
            }, { passive: true });
        
            swipeTarget.addEventListener('touchend', function(e) {
                const endX = e.changedTouches[0].clientX;
                if (startX - endX > 50) { // Swipe left
                    onSwipeLeft();
                } else if (startX - endX < -50) { // Swipe right
                    onSwipeRight();
                }
            }, { passive: true });
        });
        
        function openTabForInput(input) {
            const tabPane = input.closest('.tab-pane');
            if (!tabPane) return;
        
            const tabId = tabPane.id;
            const correspondingTab = document.querySelector(`[data-bs-target="#${tabId}"]`);
            if (correspondingTab) {
                new bootstrap.Tab(correspondingTab).show();
            }
        }

        function showError(input, isRequired, isValueMissing, isPercentInput, isValidPercent) {
            // Remove existing error messages if any
            const existingErrorMessage = input.nextElementSibling;
            if (existingErrorMessage && existingErrorMessage.classList.contains('error-message')) {
                input.parentNode.removeChild(existingErrorMessage);
            }
        
            let errorMessageText = "Please enter a valid number.";
            if (isRequired && isValueMissing) {
                errorMessageText = "This field is required.";
            } else if (isPercentInput && !isValidPercent) {
                errorMessageText = "Please enter a valid percent (0-100).";
            }
        
            const errorMessage = document.createElement('div');
            errorMessage.innerText = errorMessageText;
            errorMessage.style.color = "red";
            errorMessage.classList.add('error-message');
            input.parentNode.insertBefore(errorMessage, input.nextSibling);
        
            // Optionally, focus the first invalid input and open its tab
            input.focus();
            openTabForInput(input);
        }

        const submitAllButton = document.getElementById('submitAll');
        submitAllButton.addEventListener('click', function(event) {
            event.preventDefault(); // Prevent default form submission behavior
            let isFormValid = true; // Assume form is valid at the start
            let combinedFormData = {}; // Object to hold combined form data
            document.querySelector('#Type').value = document.querySelector('#Type_select').value;
            document.querySelector('#Type_select').disabled = true;
            // Select only forms within the #formContent div
            const forms = document.querySelectorAll('#formContent form');
            
        
            forms.forEach(form => {
                // Iterate over each input within each form for validation
                const inputs = form.querySelectorAll('input[type="number"], .percent-input');
                inputs.forEach(input => {
                    // Initial validation setup
                    const value = input.value.trim();
                    const isRequired = input.hasAttribute('required');
                    const isValueMissing = value === '';
                    const parsedValue = parseFloat(value);
                    const isPercentInput = input.classList.contains('percent-input');
                    const isValidPercent = !isNaN(parsedValue) && parsedValue >= 0 && parsedValue <= 100;
        
                    if ((isRequired && isValueMissing) || (!isValueMissing && isNaN(parsedValue)) || (isPercentInput && !isValidPercent)) {
                        // Validation failed, show error message
                        showError(input, isRequired, isValueMissing, isPercentInput, isValidPercent);
                        isFormValid = false; // Mark form as invalid
                    }
                });
        
                if (isFormValid) {
                    // Form is valid, proceed to aggregate form data
                    const formData = new FormData(form);
                    for (const [key, value] of formData.entries()) {
                        combinedFormData[key] = value; // Aggregate data from all forms
                    }
                }
            });
        
            // Proceed if all forms are valid
            if (isFormValid) {
                // All forms are valid, process the combined form data
                processForm(combinedFormData);
            }
        });

        function processForm(formData) {
            console.log('Processing combined form data: ', formData);
            const headers = Object.keys(formData);
            const dataString = Object.values(formData).join(',');
            const dataValuesArray = [dataString]; 
            console.log(headers, dataString, dataValuesArray)
        }
    </script>
    <script src="../core/loadLibraries.js"></script>
    <script src="../organization/pipes.js"></script>
    <script src="../core/main.js"></script>
</body>
</html>
